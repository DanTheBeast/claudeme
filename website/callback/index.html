<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CallMe</title>
  <link rel="icon" href="/logo.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600;9..40,700&family=Fraunces:opsz,wght@9..144,600;9..144,700&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --orange: #D46B50; --orange-light: #DE7F65; --orange-dark: #C05840;
      --orange-50: #FDF3F0; --orange-100: #FADED8;
      --green: #10B981; --red: #EF4444;
      --gray-900: #111827; --gray-700: #374151; --gray-500: #6B7280;
      --gray-400: #9CA3AF; --gray-200: #E5E7EB; --gray-100: #F3F4F6;
      --white: #FFFFFF;
    }
    body {
      font-family: 'DM Sans', sans-serif;
      background: linear-gradient(160deg, #FDFBF9 0%, #FFF5EF 50%, #FFE8D6 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      -webkit-font-smoothing: antialiased;
      color: var(--gray-900);
    }
    .card {
      background: var(--white);
      border: 1px solid var(--gray-100);
      border-radius: 24px;
      padding: 40px 36px;
      width: 100%;
      max-width: 380px;
      box-shadow: 0 8px 40px rgba(0,0,0,0.08);
      text-align: center;
      animation: fade-up 0.4s ease both;
    }
    @keyframes fade-up { from { opacity:0; transform:translateY(16px); } to { opacity:1; transform:translateY(0); } }
    .logo { width: 64px; height: 64px; border-radius: 18px; margin: 0 auto 20px; display: block; box-shadow: 0 4px 20px rgba(212,107,80,0.2); }
    h2 { font-family: 'Fraunces', serif; font-size: 22px; font-weight: 700; letter-spacing: -0.02em; margin-bottom: 8px; }
    .sub { font-size: 14px; color: var(--gray-500); line-height: 1.6; margin-bottom: 28px; }
    .spinner { width: 24px; height: 24px; border: 2.5px solid var(--gray-200); border-top-color: var(--orange); border-radius: 50%; animation: spin 0.7s linear infinite; margin: 0 auto 16px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Password form */
    .form-wrap { text-align: left; }
    label { display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 7px; }
    .input-wrap { position: relative; margin-bottom: 16px; }
    input[type="password"], input[type="text"] {
      width: 100%; padding: 12px 44px 12px 14px;
      border: 1.5px solid var(--gray-200); border-radius: 12px;
      font-size: 15px; font-family: 'DM Sans', sans-serif;
      background: var(--gray-100); color: var(--gray-900);
      outline: none; transition: border-color 0.15s, background 0.15s;
    }
    input:focus { border-color: var(--orange); background: var(--white); }
    .toggle-pw {
      position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
      background: none; border: none; cursor: pointer; color: var(--gray-400); padding: 4px;
      display: flex; align-items: center;
    }
    .toggle-pw:hover { color: var(--gray-700); }
    .toggle-pw svg { width: 18px; height: 18px; }
    .msg { font-size: 13px; font-weight: 500; padding: 10px 14px; border-radius: 10px; margin-bottom: 16px; display: none; }
    .msg.error { background: #FEF2F2; border: 1px solid #FECACA; color: var(--red); display: block; }
    .msg.success { background: #ECFDF5; border: 1px solid #BBF7D0; color: #059669; display: block; }
    .btn {
      width: 100%; padding: 13px;
      background: linear-gradient(135deg, var(--orange-light), var(--orange-dark));
      color: white; border: none; border-radius: 12px;
      font-size: 15px; font-weight: 700; font-family: 'DM Sans', sans-serif;
      cursor: pointer; box-shadow: 0 4px 16px rgba(212,107,80,0.3);
      transition: opacity 0.15s, transform 0.1s;
    }
    .btn:hover { opacity: 0.92; transform: translateY(-1px); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .app-link {
      display: inline-flex; align-items: center; gap: 10px;
      background: var(--gray-900); color: white; text-decoration: none;
      padding: 13px 24px; border-radius: 14px;
      font-size: 14px; font-weight: 600;
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
      transition: background 0.15s, transform 0.1s;
      margin-top: 8px;
    }
    .app-link:hover { background: #000; transform: translateY(-1px); }
    .app-link svg { width: 20px; height: 20px; flex-shrink: 0; }
  </style>
</head>
<body>
  <div class="card" id="card">
    <!-- Loading state (default) -->
    <div id="state-loading">
      <div class="spinner"></div>
      <img src="/logo.png" alt="CallMe" class="logo" style="margin-top:4px;" />
      <h2>One moment…</h2>
      <p class="sub">Verifying your link</p>
    </div>

    <!-- Password reset form -->
    <div id="state-reset" style="display:none;">
      <img src="/logo.png" alt="CallMe" class="logo" />
      <h2>Set a new password</h2>
      <p class="sub">Choose something you'll remember</p>
      <div class="form-wrap">
        <div id="msg" class="msg"></div>
        <label for="pw">New password</label>
        <div class="input-wrap">
          <input type="password" id="pw" placeholder="Min 6 characters" autocomplete="new-password" autofocus />
          <button type="button" class="toggle-pw" id="toggle-pw" aria-label="Show/hide password">
            <svg id="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
            </svg>
          </button>
        </div>
        <button class="btn" id="save-btn">Set New Password</button>
      </div>
    </div>

    <!-- Success: open app -->
    <div id="state-success" style="display:none;">
      <img src="/logo.png" alt="CallMe" class="logo" />
      <h2 style="color:#059669;">Password updated!</h2>
      <p class="sub">Open CallMe on your iPhone to sign in with your new password.</p>
      <a href="https://apps.apple.com/app/just-call-me-app/id6759512338" class="app-link">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.8-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/></svg>
        Open CallMe
      </a>
    </div>

    <!-- Error -->
    <div id="state-error" style="display:none;">
      <img src="/logo.png" alt="CallMe" class="logo" />
      <h2 style="color:#EF4444;">Link expired</h2>
      <p class="sub">This password reset link has expired or already been used. Request a new one from the app.</p>
      <a href="https://apps.apple.com/app/just-call-me-app/id6759512338" class="app-link">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.8-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/></svg>
        Open CallMe
      </a>
    </div>
  </div>

  <!-- Supabase JS (ESM via CDN) -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    const SUPABASE_URL = 'https://ibirrcmamficofgdsnvt.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImliaXJyY21hbWZpY29mZ2RzbnZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwMTk1ODYsImV4cCI6MjA4NjU5NTU4Nn0.sb_publishable_YA_3uzlBRQI-nyy2492wjQ_ptjJV48p';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON, {
      auth: { persistSession: false, detectSessionInUrl: false }
    });

    function show(id) {
      ['state-loading','state-reset','state-success','state-error'].forEach(s => {
        document.getElementById(s).style.display = s === id ? '' : 'none';
      });
    }

    function getParam(key) {
      // Check hash first (Supabase PKCE puts tokens there), then query string
      const hash = new URLSearchParams(window.location.hash.slice(1));
      const query = new URLSearchParams(window.location.search);
      return hash.get(key) || query.get(key) || null;
    }

    const type        = getParam('type');
    const accessToken = getParam('access_token');
    const refreshToken = getParam('refresh_token') || '';
    const token       = getParam('token'); // older OTP style
    const tokenHash   = getParam('token_hash');

    async function init() {
      // ── Password recovery ──────────────────────────────────────────────────
      if (type === 'recovery') {
        if (accessToken) {
          // PKCE / implicit: we have the token directly, set the session
          const { error } = await supabase.auth.setSession({ access_token: accessToken, refresh_token: refreshToken });
          if (error) { show('state-error'); return; }
          show('state-reset');
          return;
        }
        if (tokenHash || token) {
          // OTP verify style (older Supabase versions)
          const { error } = await supabase.auth.verifyOtp({
            token_hash: tokenHash || token,
            type: 'recovery',
          });
          if (error) { show('state-error'); return; }
          show('state-reset');
          return;
        }
        show('state-error');
        return;
      }

      // ── Email confirmation / magic link ───────────────────────────────────
      if (type === 'signup' || type === 'magiclink' || type === 'email') {
        if (tokenHash || token) {
          const { error } = await supabase.auth.verifyOtp({
            token_hash: tokenHash || token,
            type: type === 'signup' ? 'signup' : 'magiclink',
          });
          if (!error) { show('state-success'); return; }
        }
        if (accessToken) {
          const { error } = await supabase.auth.setSession({ access_token: accessToken, refresh_token: refreshToken });
          if (!error) { show('state-success'); return; }
        }
      }

      show('state-error');
    }

    init();

    // ── Password form ────────────────────────────────────────────────────────
    let pwVisible = false;
    document.getElementById('toggle-pw').addEventListener('click', () => {
      pwVisible = !pwVisible;
      const input = document.getElementById('pw');
      input.type = pwVisible ? 'text' : 'password';
      document.getElementById('eye-icon').innerHTML = pwVisible
        ? '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94"/><path d="M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19"/><line x1="1" y1="1" x2="23" y2="23"/>'
        : '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>';
    });

    document.getElementById('save-btn').addEventListener('click', async () => {
      const pw = document.getElementById('pw').value;
      const msg = document.getElementById('msg');
      msg.className = 'msg';

      if (pw.length < 6) {
        msg.textContent = 'Password must be at least 6 characters.';
        msg.className = 'msg error';
        return;
      }

      const btn = document.getElementById('save-btn');
      btn.disabled = true;
      btn.textContent = 'Saving…';

      const { error } = await supabase.auth.updateUser({ password: pw });
      btn.disabled = false;
      btn.textContent = 'Set New Password';

      if (error) {
        msg.textContent = error.message;
        msg.className = 'msg error';
      } else {
        show('state-success');
      }
    });

    // Submit on Enter
    document.getElementById('pw').addEventListener('keydown', e => {
      if (e.key === 'Enter') document.getElementById('save-btn').click();
    });
  </script>
</body>
</html>
